<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ACTIVATION KEYS</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script src="https://npmcdn.com/parse/dist/parse.min.js"></script>
  <script>
    Parse.initialize("2UbcjCCCAXXdMC34Xsq3se5xHv42l9zpncnBO5zk", "Ryed1qJgdnSd6xxrVqFt95aLpxEDz9DDic1aaVGq");
    Parse.serverURL = "https://parseapi.back4app.com";
  </script>
  <style>
    /* [same styles as your original] */
    /* (truncated here for space, but include the full CSS you posted above) */
  </style>
</head>
<body>

  <header>
    <div class="header-title">FEEDER MONITORING DASHBOARD</div>
  </header>

  <div class="container">
    <h2>Generated Activation Keys</h2>

    <div class="top-actions">
      <a href="dashboard.html" class="btn yellow">‚Üê Back</a>

      <div class="btn-group-right">
        <input type="number" min="1" id="search-input" class="form-control" placeholder="Search by Serial No." style="max-width: 220px;">
        <button class="btn blue" onclick="generateKey()">+ Generate</button>
        <button class="btn red" onclick="deleteUsed()">Delete Used</button>
      </div>
    </div>

    <div id="key-list" class="row gx-3 gy-3"></div>
  </div>

  <script>
    let allKeys = [];

    async function loadKeys() {
      try {
        const Keys = Parse.Object.extend("Keys");
        const query = new Parse.Query(Keys);
        query.ascending("createdAt");
        const results = await query.find();
        allKeys = results.map(keyObj => ({
          id: keyObj.id,
          key: keyObj.get("key"),
          used: keyObj.get("used") || false
        }));
        displayKeys();
      } catch (error) {
        console.error("Error loading keys:", error);
        Swal.fire("Error", "Could not fetch keys from the database.", "error");
      }
    }

    function displayKeys() {
      const searchValue = document.getElementById('search-input').value.trim();
      const searchNumber = parseInt(searchValue);
      const keysWithSerial = allKeys.map((item, idx) => ({ ...item, serial: idx + 1 }));

      let filtered = keysWithSerial.filter(item => isNaN(searchNumber) || item.serial === searchNumber);

      const list = document.getElementById('key-list');
      list.innerHTML = '';

      if (filtered.length === 0) {
        list.innerHTML = '<p class="text-center text-light">No keys found.</p>';
        return;
      }

      filtered.forEach(item => {
        const { key, used, serial } = item;

        const col = document.createElement('div');
        col.className = 'col-md-6 col-lg-4';

        const keyBox = document.createElement('div');
        keyBox.className = 'key-box';

        const keyText = document.createElement('div');
        keyText.className = 'key-text';
        keyText.textContent = `${serial} - ${key}`;

        const actions = document.createElement('div');
        actions.className = 'key-actions';

        if (!used) {
          const copyBtn = document.createElement('button');
          copyBtn.textContent = 'Copy';
          copyBtn.onclick = () => {
            navigator.clipboard.writeText(key).then(() => {
              Swal.fire({
                icon: 'success',
                title: 'Copied!',
                text: 'Key copied to clipboard.',
                timer: 1000,
                showConfirmButton: false
              });
            });
          };
          actions.appendChild(copyBtn);
        }

        const status = document.createElement('div');
        status.className = 'status-label ' + (used ? 'used' : 'unused');
        status.textContent = used ? 'Used' : 'Unused';

        actions.appendChild(status);
        keyBox.appendChild(keyText);
        keyBox.appendChild(actions);
        col.appendChild(keyBox);
        list.appendChild(col);
      });
    }

    async function generateKey() {
      try {
        const generated = generateRandomKey();
        const Keys = Parse.Object.extend("Keys");
        const keyObj = new Keys();
        keyObj.set("key", generated);
        keyObj.set("used", false);
        await keyObj.save();

        Swal.fire({ icon: 'success', title: 'Key generated!', timer: 1000, showConfirmButton: false });
        loadKeys();
      } catch (error) {
        console.error("Error generating key:", error);
        Swal.fire("Error", "Failed to generate key.", "error");
      }
    }

    function generateRandomKey(length = 16) {
      const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
      let result = '';
      for (let i = 0; i < length; i++) {
        result += chars.charAt(Math.floor(Math.random() * chars.length));
      }
      return result;
    }

    async function deleteUsed() {
      const confirmed = await Swal.fire({
        title: 'Delete All Used Keys?',
        text: 'This will permanently remove all used activation keys.',
        icon: 'warning',
        showCancelButton: true,
        confirmButtonText: 'Yes, delete',
        cancelButtonText: 'Cancel',
        confirmButtonColor: '#dc3545'
      });

      if (!confirmed.isConfirmed) return;

      try {
        const Keys = Parse.Object.extend("Keys");
        const query = new Parse.Query(Keys);
        query.equalTo("used", true);
        const usedKeys = await query.find();

        await Parse.Object.destroyAll(usedKeys);
        Swal.fire("Deleted", "Used keys removed.", "success");
        loadKeys();
      } catch (error) {
        console.error("Error deleting used keys:", error);
        Swal.fire("Error", "Failed to delete used keys.", "error");
      }
    }

    document.getElementById('search-input').addEventListener('input', () => displayKeys());
    loadKeys();
  </script>
</body>
</html>
